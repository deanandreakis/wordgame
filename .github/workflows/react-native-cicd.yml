name: React Native CI/CD

on:
  push:
    branches: [main, master]
    paths-ignore:
      - "**.md"
      - "LICENSE"
      - "docs/**"
  workflow_dispatch:
    inputs:
      buildType:
        type: choice
        description: "Build type to run"
        default: "ios-adhoc"
        options:
          - ios-adhoc
          - publish-expo
          - all

env:
  EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
  NODE_OPTIONS: --openssl-legacy-provider
  BUILD_TYPE: ${{ github.event.inputs.buildType || 'ios-adhoc' }}

jobs:
  build-ios:
    runs-on: macos-latest
    if: "!contains(github.event.head_commit.message, '[skip ci]')"
    steps:
      - name: üèó Checkout repository
        uses: actions/checkout@v4

      - name: üèó Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: üì¶ Install dependencies
        run: npm install

      - name: üçé Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: üîê Install Apple Certificate
        uses: apple-actions/import-codesign-certs@v2
        with:
          p12-file-base64: ${{ secrets.IOS_CERTIFICATE_BASE64 }}
          p12-password: ${{ secrets.IOS_CERTIFICATE_PASSWORD }}

      - name: üì± Install Provisioning Profile  
        run: |
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          echo "${{ secrets.IOS_PROVISION_PROFILE_BASE64 }}" | base64 --decode > profile.mobileprovision
          UUID=$(grep -a -A 1 'UUID' profile.mobileprovision | grep string | sed -e 's/<string>//' -e 's/<\/string>//' | tr -d '\t')
          cp profile.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/$UUID.mobileprovision
          rm profile.mobileprovision

      - name: üèó Run Expo Prebuild
        run: npx expo prebuild --platform ios --clean

      - name: üîß Install xcodeproj gem
        run: gem install xcodeproj

      - name: üîß Configure Code Signing for LetterLoom Target Only
        run: |
          ruby -r xcodeproj - <<'RUBY'
          project_path = 'ios/LetterLoom.xcodeproj'
          project = Xcodeproj::Project.open(project_path)
    
          project.targets.each do |target|
            if target.name == 'LetterLoom'
              target.build_configurations.each do |config|
                if config.name == 'Release'
                  config.build_settings['PROVISIONING_PROFILE_SPECIFIER'] = '0891c2ca-63f5-4a05-831e-be27bc4d3d7d'
                  config.build_settings['CODE_SIGN_STYLE'] = 'Manual'
                  config.build_settings['DEVELOPMENT_TEAM'] = '6XBQPB83GR'
                  config.build_settings['CODE_SIGN_IDENTITY'] = 'iPhone Distribution'
                end
              end
            end
          end
    
          project.save
          RUBY
  
      - name: üî® Build iOS App
        run: |
          xcodebuild -workspace ios/LetterLoom.xcworkspace \
            -scheme LetterLoom \
            -configuration Release \
            -destination generic/platform=iOS \
            -archivePath build/LetterLoom.xcarchive \
            archive \
            ONLY_ACTIVE_ARCH=NO

      - name: üì¶ Export IPA
        run: |
          cat > exportOptions.plist << EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>method</key>
              <string>ad-hoc</string>
              <key>teamID</key>
              <string>${{ secrets.EXPO_TEAM_ID }}</string>
              <key>signingStyle</key>
              <string>manual</string>
              <key>provisioningProfiles</key>
              <dict>
                  <key>com.letterloom.app</key>
                  <string>0891c2ca-63f5-4a05-831e-be27bc4d3d7d</string>
              </dict>
          </dict>
          </plist>
          EOF
          
          xcodebuild -exportArchive \
            -archivePath build/LetterLoom.xcarchive \
            -exportPath build \
            -exportOptionsPlist exportOptions.plist

      - name: üì§ Upload IPA
        uses: actions/upload-artifact@v4
        with:
          name: LetterLoom-AdHoc
          path: build/*.ipa
          retention-days: 30

name: React Native CI/CD

on:
  push:
    branches: [main, master]
    paths-ignore:
      - "**.md"
      - "LICENSE"
      - "docs/**"
  workflow_dispatch:
    inputs:
      buildType:
        type: choice
        description: "Build type to run"
        default: "ios-adhoc"
        options:
          - ios-adhoc
          - publish-expo
          - all

env:
  EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
  NODE_OPTIONS: --openssl-legacy-provider
  BUILD_TYPE: ${{ github.event.inputs.buildType || 'ios-adhoc' }}

jobs:
  build-ios:
    runs-on: macos-latest
    if: "!contains(github.event.head_commit.message, '[skip ci]')"
    steps:
      - name: ðŸ— Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ— Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: ðŸ“¦ Install dependencies
        run: npm install

      - name: ðŸŽ Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: ðŸ” Install signing certificate and provisioning profile
        run: |
          # Create directories
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          
          # Decode certificate
          echo "${{ secrets.IOS_CERTIFICATE_BASE64 }}" | base64 --decode > certificate.p12
          
          # Create temporary keychain
          security create-keychain -p actions build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p actions build.keychain
          security set-keychain-settings -t 3600 -u build.keychain
          
          # Import certificate to keychain
          security import certificate.p12 -k build.keychain -P ${{ secrets.IOS_CERTIFICATE_PASSWORD }} -T /usr/bin/codesign -A
          security set-key-partition-list -S apple-tool:,apple: -s -k actions build.keychain
          
          # Install provisioning profile
          echo "${{ secrets.IOS_PROVISION_PROFILE_BASE64 }}" | base64 --decode > profile.mobileprovision
          UUID=$(grep -a -A 1 'UUID' profile.mobileprovision | grep string | sed -e 's/<string>//' -e 's/<\/string>//' | tr -d '\t')
          cp profile.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/$UUID.mobileprovision
          
          # Cleanup
          rm certificate.p12 profile.mobileprovision

      - name: ðŸ— Run Expo Prebuild
        run: npx expo prebuild --platform ios --clean

      - name: ðŸ”¨ Build iOS App
        run: |
          xcodebuild -workspace ios/LetterLoom.xcworkspace \
            -scheme LetterLoom \
            -configuration Release \
            -destination generic/platform=iOS \
            -archivePath build/LetterLoom.xcarchive \
            archive \
            CODE_SIGN_STYLE=Manual \
            DEVELOPMENT_TEAM="${{ secrets.EXPO_TEAM_ID }}" \
            CODE_SIGN_IDENTITY="iPhone Distribution"

      - name: ðŸ“¦ Export IPA
        run: |
          # Create export options
          cat > exportOptions.plist << EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>method</key>
              <string>ad-hoc</string>
              <key>teamID</key>
              <string>${{ secrets.EXPO_TEAM_ID }}</string>
              <key>signingStyle</key>
              <string>manual</string>
          </dict>
          </plist>
          EOF
          
          # Export archive to IPA
          xcodebuild -exportArchive \
            -archivePath build/LetterLoom.xcarchive \
            -exportPath build \
            -exportOptionsPlist exportOptions.plist

      - name: ðŸ“¤ Upload IPA
        uses: actions/upload-artifact@v4
        with:
          name: LetterLoom-AdHoc
          path: build/*.ipa
          retention-days: 30

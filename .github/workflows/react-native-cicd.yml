name: React Native CI/CD

on:
  push:
    branches: [main, master]
    paths-ignore:
      - "**.md"
      - "LICENSE"
      - "docs/**"
  workflow_dispatch:
    inputs:
      buildType:
        type: choice
        description: "Build type to run"
        default: "ios-adhoc"
        options:
          - ios-adhoc
          - publish-expo
          - all

env:
  EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
  NODE_OPTIONS: --openssl-legacy-provider
  BUILD_TYPE: ${{ github.event.inputs.buildType || 'ios-adhoc' }}

jobs:
  build-ios:
    runs-on: macos-latest
    if: "!contains(github.event.head_commit.message, '[skip ci]')"
    steps:
      - name: ðŸ— Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ— Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: ðŸ“¦ Install dependencies
        run: npm install

      - name: ðŸŽ Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: ðŸ” Install Apple Certificate
        uses: apple-actions/import-codesign-certs@v2
        with:
          p12-file-base64: ${{ secrets.IOS_CERTIFICATE_BASE64 }}
          p12-password: ${{ secrets.IOS_CERTIFICATE_PASSWORD }}

      - name: ðŸ“± Install Provisioning Profile  
        run: |
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          echo "${{ secrets.IOS_PROVISION_PROFILE_BASE64 }}" | base64 --decode > profile.mobileprovision
          UUID=$(grep -a -A 1 'UUID' profile.mobileprovision | grep string | sed -e 's/<string>//' -e 's/<\/string>//' | tr -d '\t')
          cp profile.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/$UUID.mobileprovision
          rm profile.mobileprovision

      - name: ðŸ— Run Expo Prebuild
        run: npx expo prebuild --platform ios --clean

      - name: ðŸ”§ Configure Code Signing
        run: |
          # Create xcconfig file for code signing
          cat > /tmp/codesigning.xcconfig << EOF
          CODE_SIGN_STYLE = Manual
          DEVELOPMENT_TEAM = ${{ secrets.EXPO_TEAM_ID }}
          CODE_SIGN_IDENTITY = iPhone Distribution
          PROVISIONING_PROFILE_SPECIFIER = 0891c2ca-63f5-4a05-831e-be27bc4d3d7d
          EOF
    
      - name: ðŸ”¨ Build iOS App
        run: |
          xcodebuild -workspace ios/LetterLoom.xcworkspace \
            -scheme LetterLoom \
            -configuration Release \
            -destination generic/platform=iOS \
            -archivePath build/LetterLoom.xcarchive \
            -xcconfig /tmp/codesigning.xcconfig \ 
            archive \
            ONLY_ACTIVE_ARCH=NO

      - name: ðŸ“¦ Export IPA
        run: |
          cat > exportOptions.plist << EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>method</key>
              <string>ad-hoc</string>
              <key>teamID</key>
              <string>${{ secrets.EXPO_TEAM_ID }}</string>
              <key>signingStyle</key>
              <string>manual</string>
          </dict>
          </plist>
          EOF
          
          xcodebuild -exportArchive \
            -archivePath build/LetterLoom.xcarchive \
            -exportPath build \
            -exportOptionsPlist exportOptions.plist

      - name: ðŸ“¤ Upload IPA
        uses: actions/upload-artifact@v4
        with:
          name: LetterLoom-AdHoc
          path: build/*.ipa
          retention-days: 30

name: Test App Store Connect API

on:
  workflow_dispatch:

jobs:
  test:
    runs-on: macos-latest
    
    steps:
      - name: ðŸ” Setup App Store Connect API Key
        run: |
          mkdir -p ~/.appstoreconnect/private_keys
          echo "${{ secrets.APP_STORE_CONNECT_API_KEY_BASE64 }}" | base64 -d > \
            ~/.appstoreconnect/private_keys/AuthKey_${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}.p8
          chmod 600 ~/.appstoreconnect/private_keys/AuthKey_${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}.p8

      - name: ðŸ” Get Latest Build Number from App Store Connect
        id: latest_build
        run: |
          brew install jq 2>/dev/null || true
          
          echo "Using App Store Connect API to get build number..."
          
          # Generate JWT token
          ISSUED_AT=$(date +%s)
          EXPIRATION=$((ISSUED_AT + 1200))
          
          API_KEY_ID="${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}"
          ISSUER_ID="${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}"
          
          # Create header and payload
          HEADER=$(echo -n '{"alg":"ES256","kid":"'$API_KEY_ID'","typ":"JWT"}' | base64 | tr -d '=' | tr '/+' '_-' | tr -d '\n')
          PAYLOAD=$(echo -n '{"iss":"'$ISSUER_ID'","iat":'$ISSUED_AT',"exp":'$EXPIRATION',"aud":"appstoreconnect-v1"}' | base64 | tr -d '=' | tr '/+' '_-' | tr -d '\n')
          
          # Sign with private key
          SIGNATURE=$(echo -n "${HEADER}.${PAYLOAD}" | \
            openssl dgst -sha256 -sign ~/.appstoreconnect/private_keys/AuthKey_${API_KEY_ID}.p8 -binary | \
            base64 | tr -d '=' | tr '/+' '_-' | tr -d '\n')
          
          JWT="${HEADER}.${PAYLOAD}.${SIGNATURE}"
          
          echo "JWT token generated"
          
          # Get app ID (using --globoff to handle square brackets)
          echo "Fetching app information..."
          APP_RESPONSE=$(curl -s --globoff -H "Authorization: Bearer $JWT" \
            "https://api.appstoreconnect.apple.com/v1/apps?filter[bundleId]=com.letterloom.app")
          
          echo "App API Response:"
          echo "$APP_RESPONSE" | jq '.'
          
          # Check for errors
          if echo "$APP_RESPONSE" | jq -e '.errors' > /dev/null 2>&1; then
            echo "Error from API:"
            echo "$APP_RESPONSE" | jq '.errors'
            exit 1
          fi
          
          APP_ID=$(echo "$APP_RESPONSE" | jq -r '.data[0].id // empty')
          echo "App ID: $APP_ID"
          
          if [ -z "$APP_ID" ]; then
            echo "ERROR: Could not find app in App Store Connect"
            exit 1
          fi
          
          # Get builds for this app (using --globoff again)
          echo "Fetching builds for app..."
          BUILDS_RESPONSE=$(curl -s --globoff -H "Authorization: Bearer $JWT" \
            "https://api.appstoreconnect.apple.com/v1/builds?filter[app]=$APP_ID&sort=-version&limit=5")
          
          echo "Builds API Response:"
          echo "$BUILDS_RESPONSE" | jq '.'
          
          # Check for errors
          if echo "$BUILDS_RESPONSE" | jq -e '.errors' > /dev/null 2>&1; then
            echo "Error from API:"
            echo "$BUILDS_RESPONSE" | jq '.errors'
            exit 1
          fi
          
          # Extract latest build number
          LATEST_BUILD=$(echo "$BUILDS_RESPONSE" | jq -r '.data[0].attributes.version // "0"')
          
          echo "Latest build number: $LATEST_BUILD"
          
          if [ "$LATEST_BUILD" = "0" ] || [ "$LATEST_BUILD" = "null" ]; then
            echo "ERROR: Could not determine latest build number"
            exit 1
          fi
          
          echo "latest=$LATEST_BUILD" >> $GITHUB_OUTPUT

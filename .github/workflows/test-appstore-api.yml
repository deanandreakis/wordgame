name: Test App Store Connect API

on:
  workflow_dispatch:

jobs:
  test:
    runs-on: macos-latest
    
    steps:
      - name: ðŸ” Setup App Store Connect API Key
        run: |
          mkdir -p ~/.appstoreconnect/private_keys
          echo "${{ secrets.APP_STORE_CONNECT_API_KEY_BASE64 }}" | base64 -d > \
            ~/.appstoreconnect/private_keys/AuthKey_${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}.p8
          chmod 600 ~/.appstoreconnect/private_keys/AuthKey_${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}.p8

      - name: ðŸ” Get Latest Build Number from App Store Connect
        id: latest_build
        run: |
          brew install jq 2>/dev/null || true
          
          pip3 install PyJWT cryptography
          
          echo "Using App Store Connect API to get build number..."
          
          cat > generate_jwt.py << 'EOF'
          import jwt
          import time
          import sys
          
          api_key_id = sys.argv[1]
          issuer_id = sys.argv[2]
          key_file = sys.argv[3]
          
          with open(key_file, 'r') as f:
              private_key = f.read()
          
          issued_at = int(time.time())
          expiration = issued_at + 1200
          
          headers = {
              "alg": "ES256",
              "kid": api_key_id,
              "typ": "JWT"
          }
          
          payload = {
              "iss": issuer_id,
              "iat": issued_at,
              "exp": expiration,
              "aud": "appstoreconnect-v1"
          }
          
          token = jwt.encode(payload, private_key, algorithm="ES256", headers=headers)
          print(token)
          EOF
          
          JWT=$(python3 generate_jwt.py "${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}" "${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}" ~/.appstoreconnect/private_keys/AuthKey_${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}.p8)
          
          echo "JWT token generated"
          
          echo "Fetching app information..."
          APP_RESPONSE=$(curl -s --globoff -H "Authorization: Bearer $JWT" "https://api.appstoreconnect.apple.com/v1/apps?filter[bundleId]=com.letterloom.app")
          
          echo "App API Response:"
          echo "$APP_RESPONSE" | jq '.'
          
          if echo "$APP_RESPONSE" | jq -e '.errors' > /dev/null 2>&1; then
            echo "Error from API:"
            echo "$APP_RESPONSE" | jq '.errors'
            exit 1
          fi
          
          APP_ID=$(echo "$APP_RESPONSE" | jq -r '.data[0].id // empty')
          echo "App ID: $APP_ID"
          
          if [ -z "$APP_ID" ]; then
            echo "ERROR: Could not find app in App Store Connect"
            exit 1
          fi
          
          echo "Fetching builds for app..."
          BUILDS_RESPONSE=$(curl -s --globoff -H "Authorization: Bearer $JWT" "https://api.appstoreconnect.apple.com/v1/builds?filter[app]=$APP_ID&sort=-version&limit=5")
          
          echo "Builds API Response:"
          echo "$BUILDS_RESPONSE" | jq '.'
          
          if echo "$BUILDS_RESPONSE" | jq -e '.errors' > /dev/null 2>&1; then
            echo "Error from API:"
            echo "$BUILDS_RESPONSE" | jq '.errors'
            exit 1
          fi
          
          LATEST_BUILD=$(echo "$BUILDS_RESPONSE" | jq -r '.data[0].attributes.version // "0"')
          
          echo "Latest build number: $LATEST_BUILD"
          
          if [ "$LATEST_BUILD" = "0" ] || [ "$LATEST_BUILD" = "null" ]; then
            echo "ERROR: Could not determine latest build number"
            exit 1
          fi
          
          echo "latest=$LATEST_BUILD" >> $GITHUB_OUTPUT

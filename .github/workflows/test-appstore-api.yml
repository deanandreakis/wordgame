name: Test App Store Connect API

on:
  workflow_dispatch:

jobs:
  test:
    runs-on: macos-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ” Setup App Store Connect API Key
        run: |
          mkdir -p ~/.appstoreconnect/private_keys
          echo "${{ secrets.APP_STORE_CONNECT_API_KEY_BASE64 }}" | base64 -d > \
            ~/.appstoreconnect/private_keys/AuthKey_${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}.p8
          chmod 600 ~/.appstoreconnect/private_keys/AuthKey_${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}.p8

      - name: ðŸ” Get Latest Build Number from App Store Connect
        id: latest_build
        run: |
          brew install jq 2>/dev/null || true
          
          pip3 install --break-system-packages PyJWT cryptography
          
          echo "Using App Store Connect API to get build number..."
          
          # Get app version from app.json or app.config.js
          if [ -f "app.json" ]; then
            APP_VERSION=$(jq -r '.expo.version // "1.0.0"' app.json)
          else
            APP_VERSION="1.0.0"
          fi
          
          echo "App version: $APP_VERSION"
          
          cat > generate_jwt.py << 'EOF'
          import jwt
          import time
          import sys
          
          api_key_id = sys.argv[1]
          issuer_id = sys.argv[2]
          key_file = sys.argv[3]
          
          with open(key_file, 'r') as f:
              private_key = f.read()
          
          issued_at = int(time.time())
          expiration = issued_at + 1200
          
          headers = {
              "alg": "ES256",
              "kid": api_key_id,
              "typ": "JWT"
          }
          
          payload = {
              "iss": issuer_id,
              "iat": issued_at,
              "exp": expiration,
              "aud": "appstoreconnect-v1"
          }
          
          token = jwt.encode(payload, private_key, algorithm="ES256", headers=headers)
          print(token)
          EOF
          
          JWT=$(python3 generate_jwt.py "${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}" "${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}" ~/.appstoreconnect/private_keys/AuthKey_${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}.p8)
          
          echo "JWT token generated"
          
          # Get app ID
          echo "Fetching app information..."
          APP_RESPONSE=$(curl -s --globoff -H "Authorization: Bearer $JWT" "https://api.appstoreconnect.apple.com/v1/apps?filter[bundleId]=com.letterloom.app")
          
          APP_ID=$(echo "$APP_RESPONSE" | jq -r '.data[0].id // empty')
          echo "App ID: $APP_ID"
          
          if [ -z "$APP_ID" ]; then
            echo "ERROR: Could not find app in App Store Connect"
            echo "$APP_RESPONSE" | jq '.'
            exit 1
          fi
          
          # Get preReleaseVersion ID for this app version
          echo "Fetching preReleaseVersion for version $APP_VERSION..."
          PRERELEASE_RESPONSE=$(curl -s --globoff -H "Authorization: Bearer $JWT" \
            "https://api.appstoreconnect.apple.com/v1/preReleaseVersions?filter[app]=$APP_ID&filter[version]=$APP_VERSION&filter[platform]=IOS")
          
          echo "PreRelease Version Response:"
          echo "$PRERELEASE_RESPONSE" | jq '.'
          
          PRERELEASE_ID=$(echo "$PRERELEASE_RESPONSE" | jq -r '.data[0].id // empty')
          echo "PreRelease Version ID: $PRERELEASE_ID"
          
          if [ -z "$PRERELEASE_ID" ]; then
            echo "No builds found for version $APP_VERSION yet. Starting with build number 1."
            LATEST_BUILD="0"
          else
            # Get the latest build for this preReleaseVersion
            echo "Fetching latest build for this version..."
            BUILDS_RESPONSE=$(curl -s --globoff -H "Authorization: Bearer $JWT" \
              "https://api.appstoreconnect.apple.com/v1/builds?filter[preReleaseVersion]=$PRERELEASE_ID&sort=-uploadedDate&limit=1")
            
            echo "Builds Response:"
            echo "$BUILDS_RESPONSE" | jq '.'
            
            LATEST_BUILD=$(echo "$BUILDS_RESPONSE" | jq -r '.data[0].attributes.version // "0"')
          fi
          
          echo "Latest build number: $LATEST_BUILD"
          echo "latest=$LATEST_BUILD" >> $GITHUB_OUTPUT
